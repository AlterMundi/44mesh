# Border Router Node
# BGP peering with ISP + Netmaker mesh connectivity
#
# Components:
#   - netclient: WireGuard mesh (connects to netmaker.altermundi.net)
#   - bird: BGP daemon (peers with RPi ISP at 172.30.0.1)

services:
  netclient:
    image: gravitl/netclient:v0.24.2
    container_name: netclient
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    network_mode: host
    volumes:
      - netclient_data:/etc/netclient
    environment:
      TOKEN: "${ENROLLMENT_TOKEN}"
    healthcheck:
      test: ["CMD-SHELL", "wg show | grep -q 'interface:'"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s
    restart: unless-stopped

  bird:
    build: .
    container_name: bird-border
    network_mode: host
    cap_add:
      - NET_ADMIN
    env_file:
      - .env
    environment:
      # BGP Configuration
      - BORDER_ROUTER_AS=${BORDER_ROUTER_AS:-42000}
      - BORDER_ROUTER_IP=${BORDER_ROUTER_IP:-10.20.30.1}
      - ISP_AS=${ISP_AS:-42001}
      - ISP_IP=${ISP_IP:-10.20.30.254}
      - MESH_ADDRESS_RANGE=${MESH_ADDRESS_RANGE:-138.255.89.0/24}
      - TEST_PREFIX_1=${TEST_PREFIX_1:-192.0.2.0/24}
      - TEST_PREFIX_2=${TEST_PREFIX_2:-198.51.100.0/24}
      - TEST_PREFIX_3=${TEST_PREFIX_3:-203.0.113.0/24}
      - BGP_HOLD_TIME=${BGP_HOLD_TIME:-90}
      - BGP_KEEPALIVE_TIME=${BGP_KEEPALIVE_TIME:-30}
    volumes:
      - ./bird.conf.template:/etc/bird/bird.conf.template:ro
    depends_on:
      netclient:
        condition: service_healthy
    restart: unless-stopped

volumes:
  netclient_data:
